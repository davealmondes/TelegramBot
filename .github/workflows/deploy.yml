name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Acessando servidor via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER}}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            PROJETO=telegram-bot
            SERVICO=telegram-bot.service
            CAMINHO=~/telegram-bot

            echo "üîç Verificando exist√™ncia do projeto..."
            if [ ! -d "$CAMINHO/.git" ]; then
              echo "‚ö†Ô∏è Projeto n√£o encontrado. Clonando e configurando..."

              rm -rf "$CAMINHO"
              git clone git@github.com:davealmondes/TelegramBot.git "$CAMINHO"

              cd "$CAMINHO"

              echo "üêç Criando ambiente virtual..."
              python3 -m venv venv

              echo "üì¶ Instalando depend√™ncias..."
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt

              echo "üîê Gerando arquivo .env"
              echo BOT_TOKEN=${{secrets.BOT_TOKEN}} > .env
              echo BOT_ADMIN_ID=${{secrets.BOT_ADMIN_ID}} >> .env
              chmod 600 .env

              echo "üõ†Ô∏è Instalando e ativando servi√ßo systemd..."
              sudo cp "$SERVICO" /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable "$SERVICO"
              sudo systemctl start "$SERVICO"
            
            else
              echo "üîÑ Projeto j√° existe. Atualizando c√≥digo..."
              cd "$CAMINHO"
              git fetch
              git reset --hard origin/main

              echo "üì¶ Atualizando depend√™ncias..."
              source venv/bin/activate
              pip install -r requirements.txt

              echo "üîê Gerando arquivo .env"
              echo BOT_TOKEN=${{secrets.BOT_TOKEN}} > .env
              echo BOT_ADMIN_ID=${{secrets.BOT_ADMIN_ID}} >> .env
              echo WEBHOOK_SECRET_TOKEN=${{secrets.WEBHOOK_SECRET_TOKEN}} >> .env
              echo WEBHOOK_URL=${{secrets.WEBHOOK_URL}} >> .env
              chmod 600 .env

              echo "üîÅ Reiniciando servi√ßo..."
              sudo cp "$SERVICO" /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl reload "$SERVICO"
            fi

            echo "‚úÖ Deploy finalizado!"
