name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Acessando servidor via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: 'ubuntu'
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            PROJETO=telegram-bot
            SERVICO=telegram-bot.service
            CAMINHO=~/telegram-bot

            echo "ğŸ” Verificando existÃªncia do projeto..."
            if [ ! -d "$CAMINHO/.git" ]; then
              echo "âš ï¸ Projeto nÃ£o encontrado. Clonando e configurando..."

              rm -rf "$CAMINHO"
              git clone git@github.com:davealmondes/TelegramBot.git "$CAMINHO"

              cd "$CAMINHO"

              echo "ğŸ Criando ambiente virtual..."
              python3 -m venv venv

              echo "ğŸ“¦ Instalando dependÃªncias..."
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt

              echo "ğŸ› ï¸ Instalando e ativando serviÃ§o systemd..."
              sudo cp "$SERVICO" /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable "$SERVICO"
              sudo systemctl start "$SERVICO"
            else
              echo "ğŸ”„ Projeto jÃ¡ existe. Atualizando cÃ³digo..."
              cd "$CAMINHO"
              git fetch
              git reset --hard origin/main

              echo "ğŸ“¦ Atualizando dependÃªncias..."
              source venv/bin/activate
              pip install -r requirements.txt

              echo "ğŸ” Reiniciando serviÃ§o..."
              sudo systemctl daemon-reload
              sudo systemctl restart "$SERVICO"
            fi

            echo "âœ… Deploy finalizado!"
